<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <link href="http://cdncatalog.com/assets/flat-ui/css/bootstrap.css" rel="stylesheet">
        <link href="http://cdncatalog.com/assets/flat-ui/css/flat-ui.css" rel="stylesheet">

        <script type="text/template" id="tpl-table">
            <thead>
              {{#fields}}<th><span title="{{description}}">{{name}}</span></th>{{/fields}}
              <th>&nbsp;</th>
              <th>&nbsp;</th>
            </thead>
            <tbody></tbody>
        </script>

        <script type="text/template" id="tpl-row">
            {{#fieldsValues}}<td>{{.}}</td>{{/fieldsValues}}
            <td><a href="#" class="edit">Edit</a></td>
            <td><a href="#" class="close">x</a></td>
        </script>
    </head>
    <body class="row">

        <div id="form-holder" class="span4"></div>
        <div id="records-list" class="span8"></div>

        <script type="text/javascript">
            window.onload = function () {

                Daybed.SETTINGS.SERVER = "http://daybed.lolnet.org";

                // A view for one line in the list.
                // It reacts to record change and deletion.
                var RecordView = Backbone.View.extend({
                    tagName: 'tr',
                    template: Mustache.compile($('#tpl-row').html()),
                    events: {
                        'click .edit': 'edit',
                        'click .close': 'destroy'
                    },
                    initialize: function () {
                        this.model.on('change', this.render, this);
                        this.model.on('destroy', this.remove, this);
                    },
                    render: function (){
                        this.$el.html(this.template(this.model));
                        return this;
                    },
                    destroy: function (){
                        this.model.destroy();
                    },
                    edit: function () {
                        this.$el.addClass('info');
                        this.trigger('edit', this.model)
                    }
                });

                // A view for the whole collection.
                // It adds list headers and reacts to additions in collection.
                var ListView = Backbone.View.extend({
                    tagName: 'table',
                    className: 'table',
                    template: Mustache.compile($('#tpl-table').html()),
                    initialize: function () {
                        this.collection.on('add', this.addOne, this);
                        this.collection.on('reset', this.addAll, this);
                    },
                    render: function () {
                        this.$el.html(this.template(this.collection.definition.attributes));
                        return this;
                    },
                    addOne: function (record) {
                        var view = new RecordView({model: record});
                        view.on('edit', this.edit, this);
                        this.$('tbody').prepend(view.render().el);
                    },
                    addAll: function () {
                        this.collection.each(this.addOne, this);
                    },
                    edit: function (record) {
                        this.trigger('edit', record);
                    }
                });


                // Choose definition by its id
                var definition = new Daybed.Definition({id: 'demo-quotes'}),
                    itemList = new Daybed.ItemList(definition);

                // Instantiate views
                var listView = new ListView({collection: itemList})
                    formView = new Daybed.FormView({definition: definition});

                // Rebuild the form with bound instance on edit.
                listView.on('edit', function (record) {
                    formView.setup(record);
                    formView.render();
                });

                // On cancel, start again with a creation form
                formView.on('cancel', function () {
                    formView.setup(null);
                    formView.render();
                });

                // On creation, add to the collection.
                formView.on('created', function (record) {
                    itemList.add(record);
                });

                // After edition, empty the form.
                formView.on('saved created', function () {
                    formView.cancel();  // reset form
                });

                // Once done with form, remove row highlight
                formView.on('cancel saved created', function () {
                    $('tr.info').removeClass('info');
                });

                // Wait for definition to be fetched from server
                // in order to populate form fields and list headers
                definition.whenReady(function () {
                    $('#records-list').html(listView.render().el);
                    $('#form-holder').html(formView.render().el);
                });

                // Fetch definition !
                definition.fetch();
                // Fetch records !
                itemList.fetch();

            };
        </script>

        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.0/mustache.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/backbone-forms/0.12.0/backbone-forms.min.js"></script>
        <script type="text/javascript" src="backbone-daybed.js"></script>
    </body>
</html>
